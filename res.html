<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منصة التقدّم — دخول | مستخدم / أدمن</title>
  <style>
    body{margin:0;background:#0b1024;color:#e5e7eb;font-family:"Tajawal",sans-serif;min-height:100dvh;display:flex;justify-content:center;align-items:center;padding:20px}
    .wrap{width:min(1200px,100%)}
    .card{background:#111827cc;border:1px solid #3b445a;border-radius:16px;padding:16px;margin-top:14px}
    h1,h2,h3{margin:0 0 10px}
    .row{display:flex;gap:12px;align-items:center}
    .btn{background:#0f1b47;border:1px solid #3b445a;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    input[type=text],input[type=password],input[type=number]{background:#081136;border:1px solid #3b445a;color:#e5e7eb;padding:8px 10px;border-radius:10px}
    .muted{color:#9aa4b2}
    .segmented{display:grid;grid-template-columns:repeat(10,1fr);gap:8px}
    .segwrap{display:flex;flex-direction:column;gap:4px;align-items:stretch}
    .cap{text-align:center;font-size:12px;color:#bbb}
    .segment{position:relative;height:30px;border-radius:6px;background:#222}
    .fill{position:absolute;top:0;left:0;bottom:0;width:0%;background:cyan}
    .pct{position:absolute;inset:0;display:grid;place-items:center;font-size:12px;color:#fff}
    .grid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .head{color:#aaa;font-size:14px}
    .rowc{display:contents}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{border-bottom:1px solid #3b445a;padding:6px 8px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- Login -->
    <section class="card" id="view-login">
      <h1>تسجيل الدخول</h1>
      <p class="muted">اختر الدور ثم أدخل الاسم. إن كنت أدمن أدخل كود الأدمن.</p>
      <div class="row">
        <label><input type="radio" name="role" value="user" checked> مستخدم</label>
        <label><input type="radio" name="role" value="admin"> أدمن</label>
      </div>
      <div class="row" style="margin-top:8px">
        <label>الاسم: <input id="loginName" type="text"></label>
        <label id="adminCodeWrap" style="display:none">كود الأدمن: <input id="adminCode" type="password"></label>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="loginBtn">دخول</button>
      </div>
    </section>

    <!-- User -->
    <section class="card" id="view-user" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h2>لوحة المستخدم <span id="userNameTag"></span></h2>
        <button class="btn" id="logout1">خروج</button>
      </div>
      <div class="row" style="justify-content:space-between;margin:6px 0 12px">
        <div>التقدّم الكلي: <b id="overallNum">0%</b></div>
        <div><label>عدد: <input id="globalCount" type="number" min="0" value="0"></label></div>
      </div>
      <div class="segmented" id="segmentedBar"></div>
      <div class="card" style="margin-top:14px">
        <div class="grid" id="grid">
          <div class="head">البند</div>
          <div class="head">أنجزت</div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section class="card" id="view-admin" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h2>لوحة الأدمن</h2>
        <button class="btn" id="logout2">خروج</button>
      </div>
      <div id="adminContent"></div>
    </section>
  </div>

<script>
(function(){
  // ================= CONFIG =================
  const ADMIN_CODE = "admin123"; // غيّره كما تشاء

  // ================= DATA MODEL =================
  const CATS=[
    {name:"الكتب", factor:10,  unlimited:true},
    {name:"التبرعات", factor:261, unlimited:true},
    {name:"الملابس", factor:9,   unlimited:true},
    {name:"تحقيق الأماني", factor:133, unlimited:false},
    {name:"فرحة", factor:63,  unlimited:false},
    {name:"إطعام", factor:350, unlimited:false},
    {name:"مساعدة عابرة", factor:60,  unlimited:false},
    {name:"نشر أخلاقيات", factor:1,  unlimited:false},
    {name:"الأدوية", factor:250, unlimited:true,  fixed:true},
    {name:"تبرع بالدم", factor:1,   unlimited:false, fixed:true}
  ];

  // ================= STORAGE =================
  const S_USERS   = 'progress10:users';     // { username: { count, done[], updatedAt } }
  const S_SESSION = 'progress10:session';   // { role, username }
  const nowIso = ()=> new Date().toISOString();
  function getUsers(){ try{ return JSON.parse(localStorage.getItem(S_USERS)||'{}'); } catch(e){ return {}; } }
  function saveUsers(map){ localStorage.setItem(S_USERS, JSON.stringify(map)); }
  function ensureUser(username){ const m=getUsers(); if(!m[username]){ m[username]={count:0, done:Array(CATS.length).fill(0), updatedAt:nowIso()}; saveUsers(m);} return readUser(username); }
  function readUser(username){ const m=getUsers(); return m[username] ? {...m[username]} : {count:0, done:Array(CATS.length).fill(0), updatedAt:nowIso()}; }
  function writeUser(username, data){ const m=getUsers(); m[username] = {...data, updatedAt:nowIso()}; saveUsers(m); }

  // ================= EL REFS =================
  const viewLogin = document.getElementById('view-login');
  const viewUser  = document.getElementById('view-user');
  const viewAdmin = document.getElementById('view-admin');

  const loginName = document.getElementById('loginName');
  const adminCodeEl   = document.getElementById('adminCode');
  const adminCodeWrap = document.getElementById('adminCodeWrap');
  const loginBtn = document.getElementById('loginBtn');
  const roleRadios = Array.from(document.querySelectorAll('input[name=role]'));

  const userNameTag = document.getElementById('userNameTag');
  const overallNum  = document.getElementById('overallNum');
  const globalCount = document.getElementById('globalCount');
  const segmentedBar= document.getElementById('segmentedBar');
  const grid        = document.getElementById('grid');
  const adminContent= document.getElementById('adminContent');

  // ================= HELPERS =================
  function show(view){ viewLogin.style.display='none'; viewUser.style.display='none'; viewAdmin.style.display='none'; view.style.display='block'; }
  function getRole(){ const r = roleRadios.find(x=>x.checked); return r ? r.value : 'user'; }

  function targetFor(user,i){ const cat=CATS[i]; return cat.fixed ? cat.factor : cat.factor * (+user.count||0); }
  function pctFor(user,i){ const t=targetFor(user,i), d=+user.done[i]||0; if(t<=0) return 0; let p=(d/t)*100; if(!CATS[i].unlimited) p=Math.min(p,240); return Math.round(p); }
  function overallPct(user){ const sumT=CATS.reduce((a,_,i)=>a+targetFor(user,i),0); const sumD=user.done.reduce((a,b)=>a+(+b||0),0); return sumT>0?Math.round((sumD/sumT)*100):0; }

  function refreshHeader(user){ overallNum.textContent = overallPct(user) + '%'; }
  function renderSegmentsOnly(user){
    segmentedBar.innerHTML='';
    CATS.forEach((cat,i)=>{
      const wrap=document.createElement('div'); wrap.className='segwrap';
      const cap=document.createElement('div'); cap.className='cap'; cap.textContent=cat.name;
      const seg=document.createElement('div'); seg.className='segment';
      const v=pctFor(user,i);
      const fill=document.createElement('div'); fill.className='fill'; fill.style.width=Math.max(0,Math.min(100,v))+'%';
      const pctEl=document.createElement('div'); pctEl.className='pct'; pctEl.textContent=v+'%';
      seg.appendChild(fill); seg.appendChild(pctEl); wrap.appendChild(cap); wrap.appendChild(seg);
      seg.title = `${cat.name} — أنجزت ${user.done[i]} من هدف ${targetFor(user,i)}`;
      segmentedBar.appendChild(wrap);
    });
  }

  // ================= USER VIEW =================
  function renderUser(user, username){
    userNameTag.textContent = '@'+username;
    refreshHeader(user);
    globalCount.value = user.count;
    renderSegmentsOnly(user);

    // Build inputs once
    Array.from(grid.querySelectorAll('.rowc')).forEach(x=>x.remove());
    CATS.forEach((cat,i)=>{
      const r1=document.createElement('div'); r1.className='rowc'; r1.textContent=`${i+1}. ${cat.name}`;
      const r2=document.createElement('div'); r2.className='rowc';
      const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='any'; inp.value=user.done[i]; r2.appendChild(inp);
      grid.appendChild(r1); grid.appendChild(r2);
      inp.addEventListener('input',()=>{
        let v=+inp.value||0; if(!cat.unlimited){ const cap=targetFor(user,i)*2.4; if(v>cap) v=cap; }
        user.done[i]=v; inp.value=v; writeUser(username,user); renderSegmentsOnly(user); refreshHeader(user);
      });
    });

    // Count change
    globalCount.oninput = ()=>{ user.count = +globalCount.value||0; writeUser(username,user); renderSegmentsOnly(user); refreshHeader(user); };

    // Logout
    const logout1 = document.getElementById('logout1');
    if(logout1) logout1.onclick = ()=>{ localStorage.removeItem(S_SESSION); show(viewLogin); };
  }

  // ================= ADMIN VIEW =================
  function renderAdmin(){
    const users = getUsers();
    const names = Object.keys(users).sort();
    if(names.length===0){ adminContent.innerHTML = '<p class="muted">لا يوجد مستخدمون بعد.</p>'; return; }

    const catHeads = CATS.map(c=>`<th>${c.name}</th>`).join('');
    const thead = `<thead><tr><th>المستخدم</th><th>عدد</th><th>التقدّم الكلي</th>${catHeads}<th>آخر تحديث</th></tr></thead>`;

    const tbody = '<tbody>' + names.map(u=>{
      const user = users[u];
      const op = overallPct(user);
      const cells = CATS.map((cat,i)=>{
        const d = +user.done[i]||0; const t = targetFor(user,i); const p = pctFor(user,i);
        return `<td title="الهدف: ${t} — النسبة: ${p}%">${d}</td>`;
      }).join('');
      const ts = new Date(user.updatedAt).toLocaleString('ar-EG');
      return `<tr><td>@${u}</td><td>${user.count}</td><td>${op}%</td>${cells}<td class="muted">${ts}</td></tr>`;
    }).join('') + '</tbody>';

    adminContent.innerHTML = `<div class="tablewrap"><table>${thead}${tbody}</table></div>`;

    const logout2 = document.getElementById('logout2');
    if(logout2) logout2.onclick = ()=>{ localStorage.removeItem(S_SESSION); show(viewLogin); };
  }

  // ================= LOGIN LOGIC =================
  roleRadios.forEach(r=> r.addEventListener('change', ()=>{ adminCodeWrap.style.display = (getRole()==='admin') ? '' : 'none'; }));

  loginBtn.addEventListener('click', ()=>{
    const role = getRole();
    if(role==='admin'){
      if((adminCodeEl.value||'') !== ADMIN_CODE){ alert('كود الأدمن غير صحيح'); return; }
      localStorage.setItem(S_SESSION, JSON.stringify({role:'admin'}));
      show(viewAdmin); renderAdmin();
      return;
    }
    // user
    const name = (loginName.value||'').trim();
    if(!name){ alert('من فضلك أدخل اسم المستخدم'); return; }
    ensureUser(name);
    localStorage.setItem(S_SESSION, JSON.stringify({role:'user', username:name}));
    show(viewUser); renderUser(readUser(name), name);
  });

  // ================= BOOT =================
  try{
    const sess = JSON.parse(localStorage.getItem(S_SESSION)||'null');
    if(sess && sess.role==='admin'){ show(viewAdmin); renderAdmin(); }
    else if(sess && sess.role==='user' && sess.username){ show(viewUser); renderUser(readUser(sess.username), sess.username); }
    else { show(viewLogin); }
  }catch(e){ show(viewLogin); }
})();
</script>
</body>
</html>

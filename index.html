<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منصة التقدّم — دخول | مستخدم / أدمن</title>
  <style>
    :root{--bg:#0b1024;--card:#111827cc;--stroke:#3b445a;--fg:#e5e7eb;--muted:#9aa4b2;--btn:#0f1b47;--seg-bg:#222;--seg-fill:#16c7f0}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;min-height:100dvh;display:flex;justify-content:center;align-items:center;padding:20px}
    .wrap{width:min(1100px,100%);margin-inline:auto}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px;margin-top:14px}
    h1,h2,h3{margin:0 0 10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{display:flex;gap:8px;align-items:center}
    .btn{background:var(--btn);border:1px solid var(--stroke);color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    input[type=text],input[type=password],input[type=number]{background:#081136;border:1px solid var(--stroke);color:var(--fg);padding:10px;border-radius:10px;min-width:180px}
    .muted{color:var(--muted)}
    .segmented{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
    .segwrap{display:flex;flex-direction:column;gap:6px}
    .cap{text-align:center;font-size:12px;color:#bbb}
    .segment{position:relative;height:34px;border-radius:8px;background:var(--seg-bg);overflow:hidden}
    .fill{position:absolute;top:0;left:0;bottom:0;width:0%;background:var(--seg-fill)}
    .pct{position:absolute;inset:0;display:grid;place-items:center;font-size:12px;color:#fff;text-shadow:0 1px 2px #0008}
    .bar{inline-size:220px;block-size:10px;background:#1f2842;border-radius:999px;overflow:hidden;display:inline-block;vertical-align:middle}
    .bar>i{display:block;block-size:100%;inline-size:0%;background:var(--seg-fill)}
    .tablewrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{border-bottom:1px solid var(--stroke);padding:8px;text-align:center;white-space:nowrap}
    .line{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dashed #2b3550}
    .line span{font-size:15px}
    .line input{width:120px;min-width:100px}
    @media (max-width:640px){input[type=text],input[type=password],input[type=number]{min-width:unset;width:100%}.line{flex-direction:row}.line input{width:100px}}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- Login -->
    <section class="card" id="view-login">
      <h1>تسجيل الدخول</h1>
      <p class="muted">اختر الدور ثم أدخل الاسم. إن كنت أدمن أدخل كود الأدمن.</p>
      <div class="row">
        <label><input type="radio" name="role" value="user" checked> مستخدم</label>
        <label><input type="radio" name="role" value="admin"> أدمن</label>
      </div>
      <div class="row" style="margin-top:8px;width:100%">
        <label style="flex:1 1 220px">الاسم: <input id="loginName" type="text" placeholder="مثال: ali123"></label>
        <label id="adminCodeWrap" style="display:none;flex:1 1 220px">كود الأدمن: <input id="adminCode" type="password" placeholder="•••••••"></label>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="loginBtn">دخول</button>
      </div>
    </section>

    <!-- User -->
    <section class="card" id="view-user" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h2>لوحة المستخدم <span id="userNameTag"></span></h2>
        <button class="btn" id="logout1">خروج</button>
      </div>
      <div class="row" style="justify-content:space-between;margin:6px 0 12px">
        <div title="المتوسط = مجموع نسب البنود ÷ عدد البنود">
          التقدّم الكلي (متوسط):
          <b id="overallNum">0%</b>
          <span class="bar" aria-hidden="true"><i id="overallBar"></i></span>
        </div>
        <div class="row" style="gap:8px">
          <label>عدد: <input id="globalCount" type="number" min="0" value="0"></label>
          <button class="btn" id="saveAllBtn" title="حفظ التغييرات">حفظ</button>
        </div>
      </div>
      <div class="segmented" id="segmentedBar"></div>
      <div class="card" style="margin-top:14px">
        <div class="row" style="width:100%;justify-content:space-between">
          <div class="muted">البند</div>
          <div class="muted">أنجزت</div>
        </div>
        <div id="lines"></div>
      </div>
    </section>

    <!-- Admin -->
    <section class="card" id="view-admin" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h2>لوحة الأدمن</h2>
        <button class="btn" id="logout2">خروج</button>
      </div>
      <div id="adminContent"></div>
    </section>
  </div>

<!-- Firebase + App Logic (Lite) -->
<script type="module">
const ADMIN_CODE = "admin123";

const firebaseConfig = {
  apiKey: "AIzaSyAzO-Jlh5CMWqANKTij9U1jayaq7Qfp_lw",
  authDomain: "res4-fb3e7.firebaseapp.com",
  projectId: "res4-fb3e7",
  storageBucket: "res4-fb3e7.appspot.com",
  messagingSenderId: "722972146284",
  appId: "1:722972146284:web:60e622b1d7500697c1b649",
  measurementId: "G-11522XE4VN"
};

/* ===== Firebase (App + Firestore Lite) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js";

let app, db;
try { app = initializeApp(firebaseConfig); db = getFirestore(app); }
catch (e) { console.error("Firebase init failed:", e); alert("أضف إعدادات firebaseConfig بشكل صحيح ثم أعد التحميل."); }

/* ===== Model ===== */
const CATS = [
  {name:"الكتب",           factor:10,  unlimited:true},
  {name:"التبرعات",        factor:261, unlimited:true},
  {name:"الملابس",         factor:9,   unlimited:true},
  {name:"تحقيق الأماني",   factor:133, unlimited:false},
  {name:"فرحة",            factor:63,  unlimited:false},
  {name:"إطعام",           factor:350, unlimited:false},
  {name:"مساعدة عابرة",    factor:60,  unlimited:false},
  {name:"نشر أخلاقيات",    factor:1,   unlimited:false},
  {name:"الأدوية",         factor:250, unlimited:true,  fixed:true},
  {name:"تبرع بالدم",      factor:1,   unlimited:false, fixed:true}
];
const USERS_COL = "users";

/* ===== Refs ===== */
const viewLogin = document.getElementById('view-login');
const viewUser  = document.getElementById('view-user');
const viewAdmin = document.getElementById('view-admin');
const loginName = document.getElementById('loginName');
const adminCodeEl = document.getElementById('adminCode');
const adminCodeWrap = document.getElementById('adminCodeWrap');
const loginBtn = document.getElementById('loginBtn');
const roleRadios = Array.from(document.querySelectorAll('input[name=role]'));
const userNameTag = document.getElementById('userNameTag');
const overallNum  = document.getElementById('overallNum');
const overallBar  = document.getElementById('overallBar');
const globalCount = document.getElementById('globalCount');
const segmentedBar= document.getElementById('segmentedBar');
const lines       = document.getElementById('lines');
const saveAllBtn  = document.getElementById('saveAllBtn');
const adminContent= document.getElementById('adminContent');

/* ===== Helpers ===== */
const S_SESSION = 'progress10:session';
const draftKey = (u)=> `progress10:draft:${u}`;
const show = v => ([viewLogin,viewUser,viewAdmin].forEach(s=>s.style.display='none'), v.style.display='block');
const getRole = () => (roleRadios.find(x=>x.checked)?.value || 'user');
const debounce = (fn, ms=700)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

const targetFor = (user,i) => CATS[i].fixed ? CATS[i].factor : CATS[i].factor * (+user.count||0);
function pctFor(user,i){
  const t=targetFor(user,i), d=+user.done[i]||0;
  if(t<=0) return 0;
  let p=(d/t)*100;
  if(!CATS[i].unlimited) p=Math.min(p,240); // سقف العرض للبنود غير اللامحدودة
  return Math.round(p);
}

/* === الجديد: متوسط نسب البنود === */
function avgPct(user){
  const total = CATS.reduce((sum,_,i)=> sum + pctFor(user,i), 0);
  return Math.round(total / CATS.length); // نقسم على 10 بنود
}

function refreshHeader(user){
  const p = avgPct(user);
  overallNum.textContent = p + '%';
  overallBar.style.width = Math.max(0, Math.min(100, p)) + '%';
}

function renderSegmentsOnly(user){
  segmentedBar.innerHTML='';
  CATS.forEach((cat,i)=>{
    const wrap=document.createElement('div'); wrap.className='segwrap';
    const cap=document.createElement('div'); cap.className='cap'; cap.textContent=cat.name;
    const seg=document.createElement('div'); seg.className='segment';
    const v=pctFor(user,i);
    const fill=document.createElement('div'); fill.className='fill'; fill.style.width=Math.max(0,Math.min(100,v))+'%';
    const pctEl=document.createElement('div'); pctEl.className='pct'; pctEl.textContent=v+'%';
    seg.appendChild(fill); seg.appendChild(pctEl); wrap.appendChild(cap); wrap.appendChild(seg);
    seg.title=`${cat.name} — أنجزت ${user.done[i]} من هدف ${targetFor(user,i)}`;
    segmentedBar.appendChild(wrap);
  });
}

/* ===== Firestore I/O (Lite) + مسودة محلية ===== */
const emptyUser = ()=> ({ count:0, done:Array(CATS.length).fill(0), updatedAt: Date.now() });
function normalizeUser(data){
  const safe = emptyUser();
  safe.count = Number(data?.count || 0);
  const raw = Array.isArray(data?.done) ? data.done : [];
  safe.done = CATS.map((_,i)=> Number(raw[i] ?? 0));
  safe.updatedAt = Number(data?.updatedAt || Date.now());
  return safe;
}
async function ensureUser(username){
  const ref = doc(db, USERS_COL, username);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    const fresh = emptyUser();
    await setDoc(ref, { ...fresh }, { merge:true });
    localStorage.setItem(draftKey(username), JSON.stringify(fresh));
    return fresh;
  }
  const u = normalizeUser(snap.data());
  localStorage.setItem(draftKey(username), JSON.stringify(u));
  return u;
}
async function readUser(username){
  const snap = await getDoc(doc(db, USERS_COL, username));
  return snap.exists() ? normalizeUser(snap.data()) : emptyUser();
}
async function readUserPreferDraft(username){
  try{
    const u = await readUser(username);
    localStorage.setItem(draftKey(username), JSON.stringify(u));
    return u;
  }catch{
    try{
      const raw = JSON.parse(localStorage.getItem(draftKey(username))||'null');
      if(raw) return normalizeUser(raw);
    }catch{}
    return emptyUser();
  }
}
async function writeUser(username, data){
  localStorage.setItem(draftKey(username), JSON.stringify(data)); // مسودة محلية
  await setDoc(doc(db, USERS_COL, username), // سحابة
    { count: data.count, done: data.done, updatedAt: Date.now() },
    { merge:true });
}

/* ===== User View (حفظ تلقائي) ===== */
function bindUserLines(user, username){
  lines.innerHTML='';

  const autosave = debounce(async ()=>{
    try { await writeUser(username, user); }
    catch(e){ console.warn('Autosave failed:', e); }
    refreshHeader(user); renderSegmentsOnly(user);
  }, 700);

  CATS.forEach((cat,i)=>{
    const row=document.createElement('div'); row.className='line';
    const nameSpan=document.createElement('span'); nameSpan.textContent = `${i+1}. ${cat.name}`;
    const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.step='any';
    inp.value = user.done[i] ?? 0;

    const handle = ()=>{
      let v=+inp.value||0;
      if(!cat.unlimited){ const cap=targetFor(user,i)*2.4; if(v>cap) v=cap; }
      user.done[i]=v; inp.value=v;
      autosave();
    };

    inp.addEventListener('input', handle);
    row.appendChild(nameSpan); row.appendChild(inp);
    lines.appendChild(row);
  });

  globalCount.oninput = ()=>{
    user.count = +globalCount.value||0;
    autosave();
  };

  saveAllBtn.onclick = async ()=>{
    try { await writeUser(username, user); alert('تم الحفظ ✅'); }
    catch(e){ console.error(e); alert('تعذّر الحفظ. راجع Console.'); }
  };

  window.addEventListener('beforeunload', ()=>{
    try{ localStorage.setItem(draftKey(username), JSON.stringify(user)); }catch{}
  }, { once:true });

  document.getElementById('logout1').onclick = ()=>{
    localStorage.removeItem(S_SESSION);
    show(viewLogin);
  };
}

async function renderUserView(username){
  userNameTag.textContent='@'+username;
  try{
    await ensureUser(username);
    const user = await readUserPreferDraft(username);
    globalCount.value = user.count;
    refreshHeader(user); renderSegmentsOnly(user);
    bindUserLines(user, username);
  }catch(e){
    console.error(e);
    alert('تعذّر تحميل بيانات المستخدم. تأكد من Firestore.');
  }
}

/* ===== Admin (Polling بدل onSnapshot) ===== */
let adminTimer=null;
function renderAdminTable(rows){
  if(rows.length===0){ adminContent.innerHTML='<p class="muted">لا يوجد مستخدمون بعد.</p>'; return; }
  const catHeads=CATS.map(c=>`<th>${c.name}</th>`).join('');
  const thead=`<thead><tr><th>المستخدم</th><th>عدد</th><th>التقدّم (متوسط)</th>${catHeads}<th>آخر تحديث</th></tr></thead>`;
  const tbody='<tbody>'+rows.map(({username,user})=>{
    const op=avgPct(user);
    const cells=CATS.map((cat,i)=>`<td title="الهدف: ${targetFor(user,i)} — النسبة: ${pctFor(user,i)}%">${+user.done[i]||0}</td>`).join('');
    const ts=new Date(user.updatedAt||Date.now()).toLocaleString('ar-EG');
    return `<tr><td>@${username}</td><td>${user.count}</td>
    <td>${op}% &nbsp;<span class="bar"><i style="width:${Math.max(0,Math.min(100,op))}%"></i></span></td>
    ${cells}<td class="muted">${ts}</td></tr>`;
  }).join('')+'</tbody>';
  adminContent.innerHTML=`<div class="tablewrap"><table>${thead}${tbody}</table></div>`;
}
async function fetchAdminOnce(){
  try{
    const snap = await getDocs(collection(db, USERS_COL));
    const rows=[];
    snap.forEach(d=> rows.push({username:d.id,user:normalizeUser(d.data())}));
    rows.sort((a,b)=> a.username.localeCompare(b.username,'ar'));
    renderAdminTable(rows);
  }catch(err){
    console.error("Admin load error:",err);
    adminContent.innerHTML='<p class="muted">تعذّر تحميل البيانات.</p>';
  }
}
function startAdminPolling(){
  document.getElementById('logout2').onclick=()=>{
    localStorage.removeItem(S_SESSION);
    if(adminTimer) clearInterval(adminTimer);
    show(viewLogin);
  };
  if(adminTimer) clearInterval(adminTimer);
  fetchAdminOnce();
  adminTimer = setInterval(fetchAdminOnce, 7000);
}

/* ===== Login Flow ===== */
roleRadios.forEach(r=> r.addEventListener('change', ()=>{ adminCodeWrap.style.display = (getRole()==='admin') ? '' : 'none'; }));
loginBtn.addEventListener('click', async ()=>{
  const role=getRole();
  if(role==='admin'){
    if((adminCodeEl.value||'')!==ADMIN_CODE){ alert('كود الأدمن غير صحيح'); return; }
    localStorage.setItem(S_SESSION, JSON.stringify({role:'admin'}));
    show(viewAdmin); startAdminPolling(); return;
  }
  const name=(loginName.value||'').trim();
  if(!name){ alert('من فضلك أدخل اسم المستخدم'); return; }
  localStorage.setItem(S_SESSION, JSON.stringify({role:'user', username:name}));
  show(viewUser); renderUserView(name);
});

/* ===== Boot ===== */
try{
  const sess = JSON.parse(localStorage.getItem(S_SESSION)||'null');
  if(sess && sess.role==='admin'){ show(viewAdmin); startAdminPolling(); }
  else if(sess && sess.role==='user' && sess.username){ show(viewUser); renderUserView(sess.username); }
  else { show(viewLogin); }
}catch{ show(viewLogin); }
</script>
</body>
</html>
